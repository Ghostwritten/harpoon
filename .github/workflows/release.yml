name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.1.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean
      draft:
        description: 'Create as draft'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  packages: write

env:
  GO_VERSION: '1.21'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # éªŒè¯å‘å¸ƒæ¡ä»¶
  validate-release:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is-prerelease: ${{ steps.version.outputs.is-prerelease }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get version from tag
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.tag }}"
        else
          VERSION="${GITHUB_REF#refs/tags/}"
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Release version: $VERSION"
        
        # æ£€æŸ¥æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
        if [[ "$VERSION" =~ -alpha|-beta|-rc ]]; then
          echo "is-prerelease=true" >> $GITHUB_OUTPUT
          echo "This is a pre-release version"
        else
          echo "is-prerelease=false" >> $GITHUB_OUTPUT
          echo "This is a stable release version"
        fi

    - name: Validate version format
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-z0-9]+(\.[0-9]+)?)?$ ]]; then
          echo "âŒ Invalid version format: $VERSION"
          echo "Expected format: v1.2.3 or v1.2.3-alpha.1"
          exit 1
        fi
        echo "âœ… Version format is valid: $VERSION"

    - name: Check if tag exists
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        if git tag -l | grep -q "^${VERSION}$"; then
          echo "âœ… Tag $VERSION exists"
        else
          echo "âŒ Tag $VERSION does not exist"
          exit 1
        fi

    - name: Verify changelog entry
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        if [ -f "docs/changelog.md" ]; then
          if grep -q "$VERSION" docs/changelog.md; then
            echo "âœ… Changelog contains entry for $VERSION"
          else
            echo "âš ï¸  Changelog does not contain entry for $VERSION"
          fi
        else
          echo "âš ï¸  Changelog file not found"
        fi

  # è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
  test-suite:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    needs: validate-release
    strategy:
      fail-fast: true
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        go-version: ['1.21']
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ matrix.go-version }}

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Run tests
      run: go test -v -race ./...

    - name: Build and test
      run: |
        go build -v ./cmd/hpn
        
        # Test basic functionality
        if [ "${{ runner.os }}" = "Windows" ]; then
          ./hpn.exe --version
        else
          chmod +x ./hpn
          ./hpn --version
        fi

  # å®‰å…¨æ‰«æ
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate-release
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Run security scan
      run: |
        go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest
        gosec ./...

    - name: Run vulnerability check
      run: |
        go install golang.org/x/vuln/cmd/govulncheck@latest
        govulncheck ./...

  # æž„å»ºå¤šå¹³å°äºŒè¿›åˆ¶æ–‡ä»¶
  build-binaries:
    name: Build Binaries
    runs-on: ubuntu-latest
    needs: [validate-release, test-suite, security-scan]
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: windows
            goarch: amd64
          - goos: freebsd
            goarch: amd64
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Build binary
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        CGO_ENABLED: 0
      run: |
        VERSION="${{ needs.validate-release.outputs.version }}"
        COMMIT="${{ github.sha }}"
        BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        
        # æž„å»ºldflags
        LDFLAGS="-s -w"
        LDFLAGS="$LDFLAGS -X github.com/harpoon/hpn/internal/version.Version=$VERSION"
        LDFLAGS="$LDFLAGS -X github.com/harpoon/hpn/internal/version.GitCommit=$COMMIT"
        LDFLAGS="$LDFLAGS -X github.com/harpoon/hpn/internal/version.GitBranch=main"
        LDFLAGS="$LDFLAGS -X github.com/harpoon/hpn/internal/version.BuildDate=$BUILD_DATE"
        LDFLAGS="$LDFLAGS -X github.com/harpoon/hpn/internal/version.BuildUser=github-actions"
        LDFLAGS="$LDFLAGS -X github.com/harpoon/hpn/internal/version.BuildHost=github-actions"
        
        # ç¡®å®šè¾“å‡ºæ–‡ä»¶å
        if [ "${{ matrix.goos }}" = "windows" ]; then
          OUTPUT="hpn-${{ matrix.goos }}-${{ matrix.goarch }}.exe"
        else
          OUTPUT="hpn-${{ matrix.goos }}-${{ matrix.goarch }}"
        fi
        
        echo "Building $OUTPUT..."
        go build -ldflags "$LDFLAGS" -o "$OUTPUT" ./cmd/hpn
        
        # éªŒè¯æž„å»ºç»“æžœ
        ls -lh "$OUTPUT"
        
        # æµ‹è¯•ç‰ˆæœ¬ä¿¡æ¯ï¼ˆä»…é™Linux AMD64ï¼‰
        if [ "${{ matrix.goos }}" = "linux" ] && [ "${{ matrix.goarch }}" = "amd64" ]; then
          chmod +x "$OUTPUT"
          ./"$OUTPUT" --version
        fi

    - name: Upload binary artifact
      uses: actions/upload-artifact@v3
      with:
        name: binaries
        path: hpn-*
        retention-days: 7

  # åˆ›å»ºå‘å¸ƒåŒ…
  create-packages:
    name: Create Release Packages
    runs-on: ubuntu-latest
    needs: [validate-release, build-binaries]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download binary artifacts
      uses: actions/download-artifact@v3
      with:
        name: binaries
        path: binaries/

    - name: Create release packages
      run: |
        VERSION="${{ needs.validate-release.outputs.version }}"
        mkdir -p packages
        
        # ä¸ºæ¯ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶åˆ›å»ºåŒ…
        for binary in binaries/hpn-*; do
          if [ ! -f "$binary" ]; then continue; fi
          
          # æå–å¹³å°ä¿¡æ¯
          basename_binary=$(basename "$binary")
          if [[ "$basename_binary" =~ hpn-([^-]+)-([^.]+)(\.exe)?$ ]]; then
            os="${BASH_REMATCH[1]}"
            arch="${BASH_REMATCH[2]}"
            ext="${BASH_REMATCH[3]}"
            
            echo "Creating package for $os-$arch..."
            
            # åˆ›å»ºä¸´æ—¶ç›®å½•
            temp_dir="temp-$os-$arch"
            mkdir -p "$temp_dir"
            
            # å¤åˆ¶æ–‡ä»¶
            cp "$binary" "$temp_dir/"
            cp README.md "$temp_dir/"
            cp LICENSE "$temp_dir/" 2>/dev/null || echo "LICENSE file not found"
            cp -r docs/ "$temp_dir/" 2>/dev/null || echo "docs directory not found"
            
            # åˆ›å»ºåŒ…
            if [ "$os" = "windows" ]; then
              # Windowsä½¿ç”¨ZIP
              package_name="hpn-${VERSION}-${os}-${arch}.zip"
              (cd "$temp_dir" && zip -r "../packages/$package_name" .)
            else
              # Unixç³»ç»Ÿä½¿ç”¨tar.gz
              package_name="hpn-${VERSION}-${os}-${arch}.tar.gz"
              tar -czf "packages/$package_name" -C "$temp_dir" .
            fi
            
            echo "Created: $package_name"
            
            # æ¸…ç†ä¸´æ—¶ç›®å½•
            rm -rf "$temp_dir"
          fi
        done
        
        # æ˜¾ç¤ºåˆ›å»ºçš„åŒ…
        echo "Created packages:"
        ls -lh packages/

    - name: Generate checksums
      run: |
        cd packages
        sha256sum * > checksums.txt
        echo "Generated checksums:"
        cat checksums.txt

    - name: Upload package artifacts
      uses: actions/upload-artifact@v3
      with:
        name: release-packages
        path: |
          packages/*.tar.gz
          packages/*.zip
          packages/checksums.txt
        retention-days: 30

  # æž„å»ºDockeré•œåƒ
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [validate-release, test-suite]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=tag
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        build-args: |
          VERSION=${{ needs.validate-release.outputs.version }}
          COMMIT=${{ github.sha }}
          BUILD_DATE=${{ github.event.head_commit.timestamp }}

  # åˆ›å»ºGitHub Release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate-release, test-suite, security-scan, create-packages, build-docker]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download package artifacts
      uses: actions/download-artifact@v3
      with:
        name: release-packages
        path: packages/

    - name: Generate release notes
      id: release-notes
      run: |
        VERSION="${{ needs.validate-release.outputs.version }}"
        
        # å°è¯•ä»Žchangelogæå–å‘å¸ƒè¯´æ˜Ž
        if [ -f "docs/changelog.md" ]; then
          # æå–å½“å‰ç‰ˆæœ¬çš„å˜æ›´å†…å®¹
          awk "/^## \[$VERSION\]/{flag=1; next} /^## \[/{flag=0} flag" docs/changelog.md > release-notes.md
          
          if [ -s release-notes.md ]; then
            echo "Found changelog entry for $VERSION"
          else
            echo "No specific changelog entry found for $VERSION, using generic notes"
            echo "Release $VERSION" > release-notes.md
            echo "" >> release-notes.md
            echo "See [CHANGELOG](docs/changelog.md) for details." >> release-notes.md
          fi
        else
          echo "No changelog found, creating generic release notes"
          echo "Release $VERSION" > release-notes.md
        fi
        
        # æ·»åŠ ä¸‹è½½é“¾æŽ¥å’Œæ ¡éªŒå’Œä¿¡æ¯
        echo "" >> release-notes.md
        echo "## ðŸ“¦ Assets" >> release-notes.md
        echo "" >> release-notes.md
        echo "Download the appropriate binary for your platform from the assets below." >> release-notes.md
        echo "" >> release-notes.md
        echo "### Checksums" >> release-notes.md
        echo "" >> release-notes.md
        echo '```' >> release-notes.md
        cat packages/checksums.txt >> release-notes.md
        echo '```' >> release-notes.md
        echo "" >> release-notes.md
        echo "### Docker Image" >> release-notes.md
        echo "" >> release-notes.md
        echo '```bash' >> release-notes.md
        echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION" >> release-notes.md
        echo '```' >> release-notes.md

    - name: Create GitHub Release
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          const version = '${{ needs.validate-release.outputs.version }}';
          const isPrerelease = '${{ needs.validate-release.outputs.is-prerelease }}' === 'true' || 
                              '${{ github.event.inputs.prerelease }}' === 'true';
          const isDraft = '${{ github.event.inputs.draft }}' === 'true';
          
          // è¯»å–å‘å¸ƒè¯´æ˜Ž
          let releaseNotes = '';
          try {
            releaseNotes = fs.readFileSync('release-notes.md', 'utf8');
          } catch (error) {
            releaseNotes = `Release ${version}`;
          }
          
          // åˆ›å»ºå‘å¸ƒ
          const release = await github.rest.repos.createRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            tag_name: version,
            name: `Harpoon ${version}`,
            body: releaseNotes,
            draft: isDraft,
            prerelease: isPrerelease
          });
          
          console.log(`Created release: ${release.data.html_url}`);
          
          // ä¸Šä¼ èµ„äº§
          const packagesDir = 'packages';
          const files = fs.readdirSync(packagesDir);
          
          for (const file of files) {
            const filePath = path.join(packagesDir, file);
            const fileContent = fs.readFileSync(filePath);
            
            console.log(`Uploading ${file}...`);
            
            await github.rest.repos.uploadReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.data.id,
              name: file,
              data: fileContent
            });
            
            console.log(`Uploaded ${file}`);
          }
          
          return release.data.html_url;

  # å‘å¸ƒåŽéªŒè¯
  post-release-validation:
    name: Post-Release Validation
    runs-on: ubuntu-latest
    needs: [validate-release, create-release]
    steps:
    - name: Validate release assets
      uses: actions/github-script@v6
      with:
        script: |
          const version = '${{ needs.validate-release.outputs.version }}';
          
          // èŽ·å–å‘å¸ƒä¿¡æ¯
          const releases = await github.rest.repos.listReleases({
            owner: context.repo.owner,
            repo: context.repo.repo
          });
          
          const release = releases.data.find(r => r.tag_name === version);
          if (!release) {
            throw new Error(`Release ${version} not found`);
          }
          
          console.log(`Found release: ${release.name}`);
          console.log(`Release URL: ${release.html_url}`);
          console.log(`Assets count: ${release.assets.length}`);
          
          // éªŒè¯å¿…éœ€çš„èµ„äº§
          const expectedAssets = [
            'checksums.txt',
            'hpn-' + version + '-linux-amd64.tar.gz',
            'hpn-' + version + '-darwin-amd64.tar.gz',
            'hpn-' + version + '-windows-amd64.zip'
          ];
          
          const assetNames = release.assets.map(a => a.name);
          
          for (const expectedAsset of expectedAssets) {
            if (assetNames.includes(expectedAsset)) {
              console.log(`âœ… Found expected asset: ${expectedAsset}`);
            } else {
              console.log(`âš ï¸  Missing expected asset: ${expectedAsset}`);
            }
          }

    - name: Test Docker image
      run: |
        VERSION="${{ needs.validate-release.outputs.version }}"
        IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION"
        
        echo "Testing Docker image: $IMAGE"
        docker run --rm "$IMAGE" --version

  # é€šçŸ¥å’Œæ€»ç»“
  notify-completion:
    name: Notify Completion
    runs-on: ubuntu-latest
    needs: [validate-release, create-release, post-release-validation]
    if: always()
    steps:
    - name: Generate summary
      run: |
        VERSION="${{ needs.validate-release.outputs.version }}"
        
        echo "## ðŸŽ‰ Release $VERSION Completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
        echo "- **Pre-release**: ${{ needs.validate-release.outputs.is-prerelease }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Validation**: ${{ needs.validate-release.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Release Creation**: ${{ needs.create-release.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Post-validation**: ${{ needs.post-release-validation.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.create-release.result }}" = "success" ]; then
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/$VERSION)" >> $GITHUB_STEP_SUMMARY
          echo "- [Docker Image](${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Test the release binaries" >> $GITHUB_STEP_SUMMARY
          echo "2. Update documentation if needed" >> $GITHUB_STEP_SUMMARY
          echo "3. Announce the release" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Release failed" >> $GITHUB_STEP_SUMMARY
          echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
        fi